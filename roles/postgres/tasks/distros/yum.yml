---
- block:
  
  - name: Download postgresql 10 repository for {{ ansible_distribution }}
    get_url:
      url: https://download.postgresql.org/pub/repos/yum/testing/10/redhat/rhel-7-x86_64/pgdg-centos10-10-2.noarch.rpm
      dest: /tmp/pgdg-centos10-10-2.noarch.rpm

  - name: Install postgresql 10 repository for {{ ansible_distribution }}
    yum:
      name: '{{ item }}'
      state: installed
    become: true
    with_items:
      - /tmp/pgdg-centos10-10-2.noarch.rpm
  
  when: ansible_distribution == 'CentOS'

- block:
  - name: Download postgresql 10 repository for {{ ansible_distribution }}
    get_url:
      url: https://download.postgresql.org/pub/repos/yum/testing/10/redhat/rhel-7-x86_64/pgdg-redhat10-10-2.noarch.rpm
      dest: /tmp/pgdg-redhat10-10-2.noarch.rpm

  - name: Install postgresql 10 repository for {{ ansible_distribution }}
    yum:
      name: '{{ item }}'
      state: installed
    become: true
    with_items:
      - /tmp/pgdg-redhat10-10-2.noarch.rpm

  when: ansible_distribution == 'RedHat'

- name: Install postgresql 10
  yum:
    name: '{{ item }}'
    state: installed
    update_cache: true
  become: true
  with_items:
    - postgresql10-server

- name: Install python psycopg2 module
  pip:
    name: psycopg2
    state: present
  become: true

- name: Initialize postgres data-dir
  raw: /usr/pgsql-10/bin/postgresql-10-setup initdb
  become: true
  ignore_errors: true

- name : Enable postgres service
  raw: systemctl enable postgresql-10.service
  become: true
  notify: start postgres
